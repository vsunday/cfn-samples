AWSTemplateFormatVersion: 2010-09-09
Parameters:
  KeyPair:
    Type: AWS::EC2::KeyPair::KeyName
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-windows-latest/Windows_Server-2019-English-Full-Base
  PubKey:
    Type: String
    Description: Public key to be added as authorized key
  SSHLocation:
    Type: String
    Description: IP address to allow ssh
  SSHPort:
    Type: String
    Description: TCP port for sshd

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties: 
      CidrBlock: 192.168.0.0/24
      Tags: 
        - Key: Name
          Value: win-vpc
          
  Subnet:
    Type: AWS::EC2::Subnet
    Properties: 
      CidrBlock: 192.168.0.0/28
      MapPublicIpOnLaunch: true
      Tags: 
        - Key: Name
          Value: win-subnet
      VpcId:
        Ref: Vpc
        
  Igw:
    Type: AWS::EC2::InternetGateway
    Properties: 
      Tags: 
        - Key: Name
          Value: win-igw
          
  VpcAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: 
      InternetGatewayId:
        Ref: Igw
      VpcId:
        Ref: Vpc
  
  RoutingTable:
    Type: AWS::EC2::RouteTable
    Properties: 
      Tags: 
        - Key: Name
          Value: win-rt
      VpcId:
        Ref: Vpc
        
  Route:
    Type: AWS::EC2::Route
    Properties: 
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: Igw
      RouteTableId:
        Ref: RoutingTable
        
  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      RouteTableId:
        Ref: RoutingTable
      SubnetId:
        Ref: Subnet
  
  NetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties: 
      Tags: 
        - Key: Name
          Value: win-nacl
      VpcId:
        Ref: Vpc
        
  InboundRule01:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 0.0.0.0/0
      Egress: false
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From:
          Ref: SSHPort
        To:
          Ref: SSHPort
      Protocol: 6
      RuleAction: allow
      RuleNumber: 100
        
  InboundRule02:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 0.0.0.0/0
      Egress: false
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 32768
        To: 65535
      Protocol: 6
      RuleAction: allow
      RuleNumber: 110
        
  InboundRule03:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 180.233.109.229/32
      Egress: false
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 50000
        To: 50100
      Protocol: 17
      RuleAction: allow
      RuleNumber: 120
        
  OutboundRule01:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 0.0.0.0/0
      Egress: true
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 80
        To: 80
      Protocol: 6
      RuleAction: allow
      RuleNumber: 100
        
  OutboundRule02:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 0.0.0.0/0
      Egress: true
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 443
        To: 443
      Protocol: 6
      RuleAction: allow
      RuleNumber: 110
        
  OutboundRule03:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 0.0.0.0/0
      Egress: true
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 32768
        To: 65535
      Protocol: 6
      RuleAction: allow
      RuleNumber: 120
        
  OutboundRule04:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 180.233.109.229/32
      Egress: true
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 4172
        To: 4172
      Protocol: 6
      RuleAction: allow
      RuleNumber: 130
        
  OutboundRule05:
    Type: AWS::EC2::NetworkAclEntry
    Properties: 
      CidrBlock: 180.233.109.229/32
      Egress: true
      NetworkAclId:
        Ref: NetworkAcl
      PortRange: 
        From: 4172
        To: 4172
      Protocol: 17
      RuleAction: allow
      RuleNumber: 140
      
  SubnetNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties: 
      NetworkAclId:
        Ref: NetworkAcl
      SubnetId:
        Ref: Subnet
        
  Instance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - config1
            - config2
        config1: 
          files: 
            C:\cfn\cfn-hup.conf:
              content:
                Fn::Sub: |
                  [main]
                  stack=${AWS::StackId}
                  region=${AWS::Region}
            C:\cfn\hooks.d\cfn-auto-reloader.conf:
              content:
                Fn::Sub: |
                  [cfn-auto-reloader-hook]
                  triggers=post.update
                  path=Resources.SharePointFoundation.Metadata.AWS::CloudFormation::Init
                  action=cfn-init.exe -v -s ${AWS::StackName} -r Instance --region ${AWS::Region}
          commands: 
            01_install_openssh_client:
              command: >-
                powershell -Command Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
            02_install_openssh_server:
              command: >-
                powershell -Command Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
            03_firewall:
              command:
                Fn::Sub: >-
                  powershell -Command New-NetFirewallRule -Name sshd -DisplayName 'My SSH setting' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort ${SSHPort}
              ignoreErrors: true
        config2:
          files:
            C:\Users\Administrator\.ssh\authorized_keys:
              content:
                Ref: PubKey
            C:\ProgramData\ssh\sshd_config:
              content: 
                Fn::Sub: |
                  Port ${SSHPort}
                  ListenAddress 0.0.0.0
                  
                  PubkeyAuthentication yes
                  AuthorizedKeysFile	.ssh/authorized_keys
                  
                  PasswordAuthentication no
                  PermitEmptyPasswords no
                  
                  # override default of no subsystems
                  Subsystem	sftp	sftp-server.exe
          services: 
            windows:
              sshd:
                enabled: true
                ensureRunning: true
                files:
                  - C:\ProgramData\ssh\sshd_config
    Properties: 
      IamInstanceProfile:
        Ref: MyInstanceProfile
      ImageId:
        Ref: LatestAmiId
      InstanceType: t3.micro
      KeyName:
        Ref: KeyPair
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          GroupSet: 
            - Ref: SecurityGroup
          SubnetId:
            Ref: Subnet
      Tags: 
        - Key: Name
          Value: win-instance
      UserData:
        Fn::Base64:
          Fn::Sub: |
            <script>
            cfn-init.exe -v -s ${AWS::StackName} --resource Instance --region ${AWS::Region}
            </script>
            
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: win-sg
      GroupName: win-sg
      SecurityGroupIngress:
        - CidrIp:
            Ref: SSHLocation
          FromPort:
            Ref: SSHPort
          IpProtocol: tcp
          ToPort:
            Ref: SSHPort
      VpcId:
        Ref: Vpc

  MyInstanceProfile: 
    Type: AWS::IAM::InstanceProfile
    Properties: 
      Path: /
      Roles: 
        - Ref: InstanceRole
        
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Path: /
